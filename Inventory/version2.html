<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory and Product Pricing Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- === FIREBASE SDKs (v10.0 - v8 Compat Syntax FIX) === -->
    <!-- We are loading the "compat" libraries. -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .page { display: none; } /* All pages hidden by default */
        .page.active { display: block; } /* Active page is shown */

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-down { animation: slideDown 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- Blob Button CSS --- */
        .blob-btn {
            z-index: 1;
            position: relative;
            padding: 16px 30px;
            margin-top: 10px;
            text-align: center;
            text-transform: uppercase;
            color: #0505A9; /* Default Cyan */
            font-size: 14px;
            font-weight: bold;
            background-color: transparent;
            outline: none;
            border: none;
            transition: color 0.5s;
            cursor: pointer;
            border-radius: 30px;
            width: 100%;
        }

        .blob-btn:before {
            content: "";
            z-index: 1;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #0505A9; /* Default Cyan */
            border-radius: 30px;
        }
        
        /* This span wraps text/icons for z-index */
        .blob-btn__content {
            position: relative;
            z-index: 10; /* Above blobs */
            transition: color 0.5s;
        }
        
        /* BUG FIX: Explicitly target content wrapper on hover */
        .blob-btn:hover, .blob-btn.active {
            color: #FFFFFF;
        }
        .blob-btn:hover .blob-btn__content, .blob-btn.active .blob-btn__content {
             color: #FFFFFF;
        }

        .blob-btn:after {
            content: "";
            z-index: -2;
            position: absolute;
            left: 6px;
            top: 6px;
            width: 100%;
            height: 100%;
            transition: all 0.3s 0.2s;
            border-radius: 30px;
        }

        .blob-btn:hover:after, .blob-btn.active:after {
            transition: all 0.3s;
            left: 0;
            top: 0;
            border-radius: 30px;
        }

        .blob-btn__inner {
            z-index: -1;
            overflow: hidden;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border-radius: 30px;
            background: #ffffff;
        }

        .blob-btn__blobs {
            position: relative;
            display: block;
            height: 100%;
            filter: url('#goo');
        }

        .blob-btn__blob {
            position: absolute;
            top: 2px;
            width: 25%;
            height: 100%;
            background: #0505A9; /* Default Cyan */
            border-radius: 100%;
            transform: translate3d(0, 150%, 0) scale(1.7);
            transition: transform 0.45s;
        }
        
        @supports(filter: url('#goo')) { .blob-btn__blob { transform: translate3d(0, 150%, 0) scale(1.4); } }
        .blob-btn__blob:nth-child(1) { left: 0%; transition-delay: 0s; }
        .blob-btn__blob:nth-child(2) { left: 30%; transition-delay: 0.08s; }
        .blob-btn__blob:nth-child(3) { left: 60%; transition-delay: 0.16s; }
        .blob-btn__blob:nth-child(4) { left: 90%; transition-delay: 0.24s; }

        .blob-btn:hover .blob-btn__blob, .blob-btn.active .blob-btn__blob {
            transform: translateZ(0) scale(1.7);
        }
        @supports(filter: url('#goo')) {
            .blob-btn:hover .blob-btn__blob, .blob-btn.active .blob-btn__blob {
                transform: translateZ(0) scale(1.4);
            }
        }
        
        /* --- Nav Blob Button --- */
        .nav-blob {
            flex: 1;
            /* v11.0: Adjusted max-width for 6 buttons */
            max-width: 180px; 
            padding: 12px 8px; /* Adjusted padding */
            font-size: 12px; /* Adjusted font size */
            margin-top: 0;
            width: auto;
        }

        /* --- Custom Blob Colors (via CSS variables) --- */
        button[style*="--blob-color"] .blob-btn__blob {
            background: var(--blob-color);
        }
        button[style*="--blob-color"]:before {
            border-color: var(--blob-color);
        }
        
        /* === MODAL FIX v8.4 (THE *FINAL* FIX) === */
        
        /* This is the overlay (the "square at the back") */
        .modal {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(17, 24, 39, 0.5); /* bg-gray-900 bg-opacity-50 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* p-4 */
            z-index: 50;
            animation: fadeIn 0.3s ease-in-out;
            
            display: none; /* Start hidden */
        }
        
        /* This is the white box (the "pop-up") */
        .modal-content {
            background-color: #ffffff; /* bg-white */
            border-radius: 0.75rem; /* rounded-xl */
            /* shadow-2xl */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Good practice */
        }

        /* === USER REQUEST: Make Modals Larger === */
        #supplierModal .modal-content,
        #inventoryModal .modal-content {
             max-width: 36rem; /* max-w-xl (larger than default lg) */
        }
        
        /* Keep other modals their original size */
        #confirmModal .modal-content { max-width: 24rem; } /* max-w-sm */
        #productOptionModal .modal-content { max-width: 48rem; } /* max-w-3xl */
        #discountModal .modal-content { max-width: 36rem; } /* max-w-xl */

        
        /* === USER REQUEST: FIX MODAL INTERNALS (NO @APPLY) === */
        .modal-header {
            padding: 1.25rem; /* p-5 */
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
            display: flex;
            justify-content: space-between; /* justify-between */
            align-items: center; /* items-center */
        }
        
        /* This is the 20px margin/padding you wanted */
        .modal-body {
            padding: 1.25rem; /* p-5 */
            overflow-y: auto;
        }
        
        /* This is the 10px spacing you wanted (space-y-4 = 1rem = 16px, which is better) */
        .modal-body > * + * {
             margin-top: 1rem; /* space-y-4 */
        }

        .modal-footer {
            background-color: #f9fafb; /* bg-gray-50 */
            padding: 1rem 1.25rem; /* px-5 py-4 */
            display: flex;
            justify-content: space-between; /* justify-between */
            align-items: center; /* items-center */
            gap: 0.75rem; /* gap-3 */
            border-bottom-left-radius: 0.75rem; /* rounded-b-xl */
            border-bottom-right-radius: 0.75rem; /* rounded-b-xl */
        }
        
        /* NEW: Image Upload Styles */
        .image-preview-item {
            position: relative;
            width: 5rem; /* w-20 */
            height: 5rem; /* h-20 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 2px dashed #d1d5db; /* border-2 border-dashed border-gray-300 */
            background-color: #f9fafb; /* bg-gray-50 */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .image-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-remove {
            position: absolute;
            top: 0.125rem; /* top-0.5 */
            right: 0.125rem; /* right-0.5 */
            background-color: #dc2626; /* bg-red-600 */
            color: #ffffff; /* text-white */
            border-radius: 9999px; /* rounded-full */
            padding: 0.125rem; /* p-0.5 */
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .image-preview-remove:hover {
            opacity: 1;
        }
        .image-upload-loading {
            animation: spin 1s linear infinite;
            color: #9ca3af; /* text-gray-400 */
        }
        
        /* --- v10.2: Discount Page Calculator --- */
        .calc-label {
            display: block;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            color: #64748b; /* text-slate-500 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .calc-input {
            width: 100%;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.625rem; /* p-2.5 */
            outline: none;
        }
        .calc-result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem; /* pt-2 */
            margin-top: 0.5rem; /* mt-2 */
            border-top: 1px solid #f1f5f9; /* border-t border-slate-100 */
        }
        .calc-result-label {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #334155; /* text-slate-700 */
        }
        .calc-result-value {
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            color: #020617; /* text-slate-900 */
            font-family: 'Inter', sans-serif; /* font-mono */
        }
    
        /* --- v1M: Simple Calculator --- */
        /* v10.9: Added Operation Display */
        .calc-operation {
            width: 100%;
            height: 1.5rem; /* h-6 */
            color: #64748b; /* text-slate-500 */
            text-align: right;
            font-family: 'Inter', sans-serif; /* font-mono */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            padding-right: 1rem; /* px-4 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calc-display {
            width: 100%;
            background-color: #f1f5f9; /* bg-slate-100 */
            border: 1px solid #e2e8f0; /* border-slate-200 */
            color: #0f172a; /* text-slate-900 */
            text-align: right;
            font-family: 'Inter', sans-serif; /* font-mono */
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            padding: 0.75rem 1rem; /* p-3 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            outline: none;
        }
        .calc-btn {
            background-color: #f1f5f9; /* bg-slate-100 */
            color: #1e293b; /* text-slate-800 */
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            padding-top: 0.75rem; /* py-3 */
            padding-bottom: 0.75rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0; /* border-slate-200 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .calc-btn:hover {
            background-color: #e2e8f0; /* bg-slate-200 */
            transform: translateY(-1px);
        }
        .calc-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .calc-btn-op {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-color: #2563eb; /* border-blue-600 */
        }
        .calc-btn-op:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        /* --- End v1M --- */
        
        /* --- v11.0: AI ASSISTANT --- */
        .chat-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem; /* p-3 px-4 */
            border-radius: 1rem; /* rounded-2xl */
            margin-bottom: 0.5rem; /* mb-2 */
            line-height: 1.6;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            margin-left: auto;
            border-bottom-right-radius: 0.25rem; /* rounded-br-lg */
        }
        .chat-bubble-ai {
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #1e293b; /* text-slate-800 */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem; /* rounded-bl-lg */
        }
        .chat-bubble-ai > p { margin-bottom: 0.75rem; }
        .chat-bubble-ai > p:last-child { margin-bottom: 0; }
        .chat-bubble-ai ul { list-style-type: disc; padding-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .chat-bubble-ai ol { list-style-type: decimal; padding-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        
        /* AI Loading Spinner */
        .ai-loading-spinner {
            display: none; /* Hidden by default */
            margin: 1rem auto;
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-width: 3px;
            border-color: #93c5fd; /* border-blue-200 */
            border-top-color: #2563eb; /* border-t-blue-600 */
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        /* --- End v11.0 --- */
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 p-4 flex-none z-10 shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-md">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-slate-900 leading-tight">Inventory and Product Pricing Pro</h1>
                    <p class="text-xs text-slate-500">v11.0 (AI Assistant)</p>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <p class="text-xs font-medium text-blue-600">Moses' Build</p>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="flex-none z-0 py-4">
        <div class="max-w-6xl mx-auto flex justify-center gap-1 sm:gap-2 px-1 sm:px-4">
            
            <button id="nav-sup" onclick="showPage('sup')" class="blob-btn nav-blob">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="users" class="w-4 h-4"></i> Suppliers
                </span>
                <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            
            <button id="nav-inv" onclick="showPage('inv')" class="blob-btn nav-blob">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="archive" class="w-4 h-4"></i> Inventory
                </span>
                 <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            
            <button id="nav-calc" onclick="showPage('calc')" class="blob-btn nav-blob">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="calculator" class="w-4 h-4"></i> Calculator
                </span>
                <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            
            <button id="nav-prod-inv" onclick="showPage('prod-inv')" class="blob-btn nav-blob">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="package-check" class="w-4 h-4"></i> Products
                </span>
                 <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            
            <button id="nav-disc" onclick="showPage('disc')" class="blob-btn nav-blob">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="percent" class="w-4 h-4"></i> Discounts
                </span>
                 <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            
            <!-- === v11.0: AI ASSISTANT BUTTON === -->
            <button id="nav-ai" onclick="showPage('ai')" class="blob-btn nav-blob" style="color: #4f46e5; --blob-color: #4f46e5;">
                <span class="flex items-center justify-center gap-2 blob-btn__content">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> AI Assistant
                </span>
                 <span class="blob-btn__inner"><span class="blob-btn__blobs"><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span><span class="blob-btn__blob"></span></span></span>
            </button>
            <!-- === End v11.0 === -->

        </div>
    </nav>

    <!-- Main Content Area (Scrollable) -->
    <main class="flex-1 overflow-y-auto scroll-smooth">
        
        <!-- ======================= -->
        <!-- == CALCULATOR PAGE == -->
        <!-- ======================= -->
        <div id="page-calc" class="page p-4">
            <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column: Product Builder -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Product Details -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5">
                        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Parent Product Details</p>
                        <div class="space-y-4">
                            <!-- Product Name -->
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Product Name <span class="text-red-500">*</span></label>
                                <input type="text" id="calcProductName" placeholder="e.g. Custom Leather Wallet" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 outline-none">
                            </div>
                            <!-- Product Description -->
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Product Description</label>
                                <textarea id="calcProductDesc" rows="3" placeholder="e.g. Bifold, red thread, 4 card slots" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 outline-none"></textarea>
                            </div>
                            
                            <!-- NEW: Product Images -->
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-2">Product Images (Max 5)</label>
                                <div class="flex flex-wrap gap-2">
                                    <!-- Image Previews -->
                                    <div id="calcImagePreview" class="flex flex-wrap gap-2">
                                        <!-- JS will populate this -->
                                    </div>
                                    <!-- Upload Button -->
                                    <label id="calcImageUploadLabel" for="calcImageUpload" class="image-preview-item cursor-pointer hover:bg-gray-100 transition-colors">
                                        <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400"></i>
                                    </label>
                                    <input type="file" id="calcImageUpload" onchange="handleImageUpload(event)" multiple accept="image/png, image/jpeg, image/gif" class="hidden">
                                </div>
                            </div>
                            
                            <!-- Tags, Platform, Keywords -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Tags</label>
                                    <input type="text" id="calcProductTags" placeholder="wallet, leather, handmade" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Platform</label>
                                    <input type="text" id="calcProductPlatform" placeholder="Shopee, Lazada, Etsy" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Keywords</label>
                                    <input type="text" id="calcProductKeywords" placeholder="custom wallet ph" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Options List -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Product Options (Sizes/Variants)</p>
                            <button onclick="showProductOptionModal()" class="text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg flex items-center gap-2 transition-all">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Option
                            </button>
                        </div>
                        
                        <div id="calcOptionList" class="space-y-3">
                            <p class="text-center text-sm text-slate-400 py-4">No options added yet. Click "Add Option" to get started.</p>
                        </div>
                    </div>
                    
                </div>

                <!-- Right Column: Save Product -->
                <div class="lg:col-span-1">
                    <div class="lg:sticky lg:top-4 space-y-4">
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Actions</p>
                            <p class="text-sm text-slate-500 mb-4">Build your product by adding options. When you're finished, save the entire product to your inventory.</p>
                            
                            <button onclick="saveProductToDb()" class="blob-btn">
                                <span class="blob-btn__content">Save Product</span>
                                <span class="blob-btn__inner">
                                    <span class="blob-btn__blobs">
                                        <span class="blob-btn__blob"></span>
                                        <span class="blob-btn__blob"></span>
                                        <span class="blob-btn__blob"></span>
                                        <span class="blob-btn__blob"></span>
                                    </span>
                                </span>
                            </button>
                            
                            <!-- === FEATURE: CANCEL UPDATE === -->
                            <!-- This button is hidden by default and only appears when editing -->
                            <button id="calcCancelBtn" onclick="cancelCalculatorUpdate()" class="w-full text-center text-sm font-medium text-blue-600 hover:text-blue-800 mt-4" style="display: none;">
                                Cancel Update
                            </button>
                            <!-- This button is visible by default and hides when editing -->
                            <button id="calcClearBtn" onclick="clearCalculator()" class="w-full text-center text-xs text-red-500 hover:text-red-700 mt-4">
                                Clear All Calculator Data
                            </button>
                            <!-- === END FEATURE === -->
                        </div>
                        
                        <!-- === v1M: SIMPLE CALCULATOR === -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Quick Calc</p>
                            <div class="calc-container">
                                <!-- v10.9: Added Operation Display -->
                                <div id="quickCalcOperation" class="calc-operation"></div>
                                <input type="text" id="quickCalcDisplay" class="calc-display" readonly placeholder="0">
                                <div class="grid grid-cols-4 gap-2 mt-2">
                                    <button onclick="calcClear()" class="calc-btn calc-btn-op col-span-2">C</button>
                                    <button onclick="calcAppend('.')" class="calc-btn">.</button>
                                    <button onclick="calcSetOperation('/')" class="calc-btn calc-btn-op">/</button>
                                    
                                    <button onclick="calcAppend('7')" class="calc-btn">7</button>
                                    <button onclick="calcAppend('8')" class="calc-btn">8</button>
                                    <button onclick="calcAppend('9')" class="calc-btn">9</button>
                                    <button onclick="calcSetOperation('*')" class="calc-btn calc-btn-op">x</button>
                                    
                                    <button onclick="calcAppend('4')" class="calc-btn">4</button>
                                    <button onclick="calcAppend('5')" class="calc-btn">5</button>
                                    <button onclick="calcAppend('6')" class="calc-btn">6</button>
                                    <button onclick="calcSetOperation('-')" class="calc-btn calc-btn-op">-</button>
                                    
                                    <button onclick="calcAppend('1')" class="calc-btn">1</button>
                                    <button onclick="calcAppend('2')" class="calc-btn">2</button>
                                    <button onclick="calcAppend('3')" class="calc-btn">3</button>
                                    <button onclick="calcSetOperation('+')" class="calc-btn calc-btn-op">+</button>
                                    
                                    <button onclick="calcAppend('0')" class="calc-btn col-span-2">0</button>
                                    <button onclick="calcCompute()" class="calc-btn calc-btn-op col-span-2">=</button>
                                </div>
                            </div>
                        </div>
                        <!-- === END 1M === -->
                        
                    </div>
                </div>

            </div>
        </div>

        <!-- ======================= -->
        <!-- == PROD. INV. PAGE == -->
        <!-- ======================= -->
        <div id="page-prod-inv" class="page p-4">
            <div class="max-w-5xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center px-1">
                     <div>
                        <h2 class="text-lg font-semibold text-slate-800">Saved Products</h2>
                        <p class="text-sm text-slate-500">All your calculated products and their variants.</p>
                    </div>
                    <button onclick="showClearConfirm('prod')" class="text-xs text-red-500 hover:text-red-700 font-medium">Clear All Products</button>
                </div>
                
                <!-- Saved Products List -->
                <div id="savedProductsList" class="space-y-4">
                    <p class="text-center text-slate-400 pt-10">No products saved yet. Go to the Calculator to build one!</p>
                </div>
            </div>
        </div>


        <!-- ======================= -->
        <!-- ==== INVENTORY PAGE === -->
        <!-- ======================= -->
        <div id="page-inv" class="page p-4">
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center px-1">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Material Inventory</h2>
                        <p class="text-sm text-slate-500">Your raw materials and their costs.</p>
                    </div>
                    <button onclick="showInventoryModal()" class="blob-btn" style="color: #6d28d9; --blob-color: #6d28d9; width: auto; padding: 10px 20px; font-size: 13px; margin: 0;">
                        <span class="blob-btn__content flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add Material
                        </span>
                        <span class="blob-btn__inner" style="background: #ffffff;">
                            <span class="blob-btn__blobs">
                                <span class="blob-btn__blob" style="background: #6d28d9;"></span>
                                <span class="blob-btn__blob" style="background: #6d28d9;"></span>
                                <span class="blob-btn__blob" style="background: #6d28d9;"></span>
                                <span class="blob-btn__blob" style="background: #6d28d9;"></span>
                            </span>
                        </span>
                    </button>
                </div>
                
                <!-- Inventory List -->
                <div id="invListContainer">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500">Current Inventory</h3>
                        <button onclick="showClearConfirm('inv')" class="text-xs text-red-500 hover:text-red-700">Clear All</button>
                    </div>
                    <div class="space-y-3" id="invList">
                         <p class="text-center text-slate-400 pt-10">No materials added yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= -->
        <!-- ==== SUPPLIERS PAGE === -->
        <!-- ======================= -->
        <div id="page-sup" class="page p-4">
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center px-1">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Suppliers</h2>
                        <p class="text-sm text-slate-500">Your list of contacts and suppliers.</p>
                    </div>
                    <button onclick="showSupplierModal()" class="blob-btn" style="color: #16a34a; --blob-color: #16a34a; width: auto; padding: 10px 20px; font-size: 13px; margin: 0;">
                        <span class="blob-btn__content flex items-center gap-2">
                             <i data-lucide="plus" class="w-4 h-4"></i> Add Supplier
                        </span>
                        <span class="blob-btn__inner" style="background: #ffffff;">
                            <span class="blob-btn__blobs">
                                <span class="blob-btn__blob" style="background: #16a34a;"></span>
                                <span class="blob-btn__blob" style="background: #16a34a;"></span>
                                <span class="blob-btn__blob" style="background: #16a34a;"></span>
                                <span class="blob-btn__blob" style="background: #16a34a;"></span>
                            </span>
                        </span>
                    </button>
                </div>

                <!-- Supplier List -->
                <div id="supList" class="space-y-3">
                    <p class="text-center text-slate-400 pt-10">No suppliers added yet.</p>
                </div>
            </div>
        </div>
        
        <!-- ======================= -->
        <!-- ==== DISCOUNTS PAGE === -->
        <!-- ======================= -->
        <div id="page-disc" class="page p-4">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center px-1">
                     <div>
                        <h2 class="text-lg font-semibold text-slate-800">Sales Engine & Discounts</h2>
                        <p class="text-sm text-slate-500">Simulate bulk orders and event sales.</p>
                    </div>
                </div>
                
                <!-- === v10.5: REFACTORED SALES ENGINE === -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Col 1: Bulk Order Calculator -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5 space-y-4">
                        <h3 class="text-base font-semibold text-slate-800 border-b border-gray-100 pb-3">Bulk Order Calculator</h3>
                        <!-- Inputs -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="calc-label">Product</label>
                                <select id="bulkProductSelect" class="calc-input"></select>
                            </div>
                             <div>
                                <label class="calc-label">Variant</label>
                                <select id="bulkVariantSelect" class="calc-input"></select>
                            </div>
                        </div>
                        <div>
                            <label class="calc-label">Order Quantity</label>
                            <input type="number" id="bulkQuantityInput" placeholder="0" class="calc-input">
                        </div>
                        <!-- Bulk Results -->
                        <div class="space-y-1 pt-2">
                            <div class="calc-result-row !border-none !pt-0 !mt-0">
                                <span class="calc-result-label">Discount Tier</span>
                                <span id="bulkDiscountTier" class="calc-result-value text-blue-600">N/A</span>
                            </div>
                            <div class="calc-result-row">
                                <span class="calc-result-label">Raw Cost / item</span>
                                <span id="bulkPuhunan" class="calc-result-value">₱0.00</span>
                            </div>
                            <div class="calc-result-row">
                                <span class="calc-result-label text-blue-600 font-bold">New Profit / item</span>
                                <span id="bulkProfitPerItem" class="calc-result-value text-blue-600 font-bold">₱0.00</span>
                            </div>
                            <div class="calc-result-row bg-slate-50 -mx-3 px-3 py-2 rounded-md">
                                <span class="calc-result-label text-lg font-bold">Total Profit</span>
                                <span id="bulkTotalProfit" class="calc-result-value text-lg font-bold text-blue-600">₱0.00</span>
                            </div>
                            <div class="calc-result-row bg-slate-50 -mx-3 px-3 py-2 rounded-md">
                                <span class="calc-result-label text-lg font-bold">Total Price</span>
                                <span id="bulkTotalPrice" class="calc-result-value text-lg font-bold">₱0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Col 2: Event Sale Calculator -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5 space-y-4">
                        <h3 class="text-base font-semibold text-slate-800 border-b border-gray-100 pb-3">Event Sale Calculator</h3>
                        <!-- Inputs -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="calc-label">Product</label>
                                <select id="eventProductSelect" class="calc-input"></select>
                            </div>
                             <div>
                                <label class="calc-label">Variant</label>
                                <select id="eventVariantSelect" class="calc-input"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="calc-label">Promo Code</label>
                                <input type="text" id="eventPromoInput" placeholder="N/A" class="calc-input">
                            </div>
                            <div>
                                <label class="calc-label">Sale Percentage</label>
                                <input type="number" id="eventPercentInput" placeholder="0" class="calc-input">
                            </div>
                        </div>
                        <!-- Event Results -->
                        <div class="space-y-1 pt-2">
                            <div class="calc-result-row !border-none !pt-0 !mt-0">
                                <span class="calc-result-label">Retail Price</span>
                                <span id="eventBasePrice" class="calc-result-value">₱0.00</span>
                            </div>
                            <div class="calc-result-row">
                                <span class="calc-result-label">Event Discount</span>
                                <span id="eventDiscountAmount" class="calc-result-value text-red-600">₱0.00</span>
                            </div>
                            <div class="calc-result-row">
                                <span class="calc-result-label text-green-600 font-bold">New Sale Price</span>
                                <span id="eventFinalPrice" class="calc-result-value text-green-600 font-bold">₱0.00</span>
                            </div>
                            <hr class="my-2">
                            <div class="calc-result-row !border-none">
                                <span class="calc-result-label">Raw Cost (Puhunan)</span>
                                <span id="eventPuhunan" class="calc-result-value">₱0.00</span>
                            </div>
                            <div class="calc-result-row bg-green-50 -mx-3 px-3 py-2 rounded-md">
                                <span class="calc-result-label text-lg font-bold">New Profit / item</span>
                                <span id="eventFinalProfit" class="calc-result-value text-lg font-bold text-green-600">₱0.00</span>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- === END v10.5 === -->
                
                <hr>
                
                <!-- Discounts List (Moved Down) -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 px-1 mb-4">Manage Discount Tiers</h3>
                    <div id="discountsList" class="space-y-4">
                        <p class="text-center text-slate-400 pt-10">No products found. Add products in the Calculator first.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- =========================== -->
        <!-- ==== AI ASSISTANT PAGE ==== -->
        <!-- =========================== -->
        <div id="page-ai" class="page p-4">
            <!-- v11.0: Full Page Flex Layout -->
            <div class="max-w-4xl mx-auto h-full flex flex-col bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden" style="height: calc(100vh - 180px);">
                <!-- Header -->
                <div class="flex-none p-4 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-slate-800">AI Business Assistant</h2>
                            <p class="text-sm text-slate-500">Your co-pilot for product descriptions, marketing, and more.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History (Scrollable) -->
                <div id="aiChatHistoryContainer" class="flex-1 p-4 overflow-y-auto space-y-4">
                    <!-- Messages will be injected here -->
                    <div class="chat-bubble chat-bubble-ai">
                        <p>Hello, Moses. I'm SIRIS, your integrated business assistant.</p>
                        <p>How can I help you today? You can ask me to do things like:</p>
                        <ul>
                            <li>"Write a product description for my Artisan Leather Wallet."</li>
                            <li>"Brainstorm 5 marketing ideas for a craft fair."</li>
                            <li>"What are some good keywords for 'handmade leather'?"</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <div id="aiLoadingSpinner" class="ai-loading-spinner"></div>
                
                <!-- Chat Input Form -->
                <div class="flex-none p-4 bg-gray-50 border-t border-gray-200">
                    <form id="aiChatForm" class="flex items-center gap-3">
                        <input type="text" id="aiChatInput" placeholder="Ask your assistant..." class="flex-1 w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition-colors flex items-center justify-center">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- === End v11.0 === -->


    </main>

    <!-- ======================= -->
    <!-- ==== MODALS === -->
    <!-- ======================= -->

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content"> <!-- Size is set by CSS rule -->
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-slate-900" id="confirmModalTitle">Clear Items</h3>
                 <button type="button" onclick="hideConfirmModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="modal-body">
                <div class="flex items-start gap-3">
                    <div class="bg-red-50 text-red-600 rounded-full p-2 flex-shrink-0">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 mt-1" id="confirmModalText">This action cannot be undone.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-end">
                <button onclick="hideConfirmModal()" class="py-2 px-4 rounded-lg text-sm font-medium border bg-white hover:bg-gray-100">Cancel</button>
                <button id="confirmModalBtn" class="py-2 px-4 rounded-lg text-sm font-medium bg-red-600 text-white hover:bg-red-700">Yes, Clear All</button>
            </div>
        </div>
    </div>
    
    <!-- Supplier Add/Edit Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content"> <!-- Size is set by CSS rule -->
            <form id="supForm">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-900" id="supplierModalTitle">Add Supplier</h3>
                    <button type="button" onclick="hideSupplierModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="supEditId">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Supplier Name <span class="text-red-500">*</span></label>
                        <input type="text" id="supName" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Contact Number</label>
                        <input type="text" id="supContact" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Address</label>
                        <input type="text" id="supAddress" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Description</label>
                        <textarea id="supDesc" rows="3" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="supplierDeleteBtn" onclick="deleteSupplier()" class="py-2 px-4 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50">Delete</button>
                    <div>
                        <button type="button" onclick="hideSupplierModal()" class="py-2 px-4 rounded-lg text-sm font-medium border bg-white hover:bg-gray-100">Cancel</button>
                        <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium bg-green-600 text-white hover:bg-green-700">Save Supplier</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Inventory Add/Edit Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content"> <!-- Size is set by CSS rule -->
            <form id="invForm">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-900" id="inventoryModalTitle">Add Material</h3>
                    <button type="button" onclick="hideInventoryModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="invEditId">
                    <!-- Common Fields -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Material Name <span class="text-red-500">*</span></label>
                            <input type="text" id="invItemName" required class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Brand / Supplier</label>
                            <select id="invSupplierSelect" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Description</label>
                        <input type="text" id="invItemDesc" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5">
                    </div>
                    <!-- Pricing Mode Toggle -->
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-2">Pricing Mode <span class="text-red-500">*</span></label>
                        <div class="flex rounded-lg shadow-sm border border-gray-300">
                            <button type="button" onclick="setInvMode('unit')" id="inv-tab-unit" class="flex-1 text-sm font-medium py-2.5 px-4 rounded-l-md transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="ruler" class="w-4 h-4"></i> Per Unit
                            </button>
                            <button type="button" onclick="setInvMode('size')" id="inv-tab-size" class="flex-1 text-sm font-medium py-2.5 px-4 rounded-r-md transition-colors flex items-center justify-center gap-2 border-l border-gray-300">
                                <i data-lucide="package" class="w-4 h-4"></i> By Size/Option
                            </button>
                        </div>
                    </div>
                    <hr>
                    <!-- "Per Unit" Section -->
                    <div id="invUnitEntry" class="space-y-4" style="display: none;"> <!-- MODAL FIX: Start hidden -->
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                             <p class="text-sm font-semibold text-slate-600 mb-2">Per Unit Pricing</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Total Cost <span class="text-red-500">*</span></label>
                                    <input type="number" id="invUnitTotalCost" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Total Units <span class="text-red-500">*</span></label>
                                    <input type="number" id="invUnitTotalQty" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Unit Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="invUnitName" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5">
                                </div>
                            </div>
                        </div>
                        <!-- NEW: Categories -->
                        <div>
                            <p class="text-sm font-semibold text-slate-600 mb-2">Categories (Optional)</p>
                            <div id="invCategoriesPreviewList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                            <div class="flex gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 mt-2">
                                <input type="text" id="invCategoryType" placeholder="e.g. Color" class="flex-1 w-1/2 bg-white border border-gray-300 text-sm rounded-lg p-2.5">
                                <input type="text" id="invCategoryValue" placeholder="e.g. Red" class="flex-1 w-1/2 bg-white border border-gray-300 text-sm rounded-lg p-2.5">
                                <button type="button" onclick="addInvCategory()" class="flex-none bg-slate-700 hover:bg-slate-600 text-white rounded-lg p-2.5 h-10"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                    <!-- "By Size/Option" Section -->
                    <div id="invSizeEntry" class="space-y-4" style="display: none;"> <!-- MODAL FIX: Start hidden -->
                        <p class="text-sm font-semibold text-slate-600">By Size/Option Pricing</p>
                        <div id="invOptionsPreviewList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                        <div class="flex gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <input type="text" id="invOptionName" placeholder="e.g. Small" class="flex-1 w-1/2 bg-white border border-gray-300 text-sm rounded-lg p-2.5">
                            <input type="number" id="invOptionPrice" placeholder="0.00" class="flex-1 w-1/3 bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                            <button type="button" onclick="addInvOption()" class="flex-none bg-slate-700 hover:bg-slate-600 text-white rounded-lg p-2.5 h-10"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="inventoryDeleteBtn" onclick="deleteInventory()" class="py-2 px-4 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50">Delete</button>
                    <div>
                        <button type="button" onclick="hideInventoryModal()" class="py-2 px-4 rounded-lg text-sm font-medium border bg-white hover:bg-gray-100">Cancel</button>
                        <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium bg-purple-600 text-white hover:bg-purple-700">Save Material</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Product Option Builder Modal (NEW) -->
    <div id="productOptionModal" class="modal">
        <div class="modal-content"> <!-- Size is set by CSS rule -->
            <form id="productOptionForm">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-900" id="productOptionModalTitle">Add Product Option</h3>
                    <button type="button" onclick="hideProductOptionModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="productOptionEditIndex">
                    <!-- Option Details -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Option Name <span class="text-red-500">*</span></label>
                            <input type="text" id="optionName" placeholder="e.g. Small, Red, 3-Card" required class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Profit Margin</label>
                            <select id="optionMargin" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5">
                                <option value="0.30">30%</option>
                                <option value="0.50" selected>50%</option>
                                <option value="0.75">75%</option>
                                <option value="1.00">100%</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <!-- Add Material Form -->
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                         <h4 class="text-sm font-semibold text-slate-700">Add Materials to this Option</h4>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Select Material from Inventory</label>
                            <select id="optionMaterialSelect" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 outline-none">
                                <option value="">-- Select a Material --</option>
                            </select>
                        </div>
                        <!-- Dynamic Inputs Appear Here -->
                        <div id="optionDynamicInputs" class="space-y-3" style="display: none;"></div> <!-- MODAL FIX: Start hidden -->
                        <button type="button" onclick="addMaterialToOption()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center gap-2">
                           Add Material
                        </button>
                    </div>
                    <!-- Breakdown List -->
                    <div id="optionCalcListContainer" style="display: none;"> <!-- MODAL FIX: Start hidden -->
                        <h4 class="text-sm font-semibold text-slate-700 mb-2">Material Breakdown</h4>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 max-h-40 overflow-y-auto" id="optionCalcList">
                            <!-- Option materials injected here -->
                        </div>
                    </div>
                    <!-- Summary -->
                    <div class="bg-slate-900 rounded-xl p-4 mt-4 text-white">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-slate-300">Total Puhunan (Cost)</span>
                            <span id="optionTotalCost" class="text-lg font-bold text-slate-100 font-mono">₱0.00</span>
                        </div>
                         <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-slate-300">Kita (<span id="optionMarginLabel">50%</span>)</span>
                            <span id="optionProfit" class="text-lg font-bold text-emerald-300 font-mono">₱0.00</span>
                        </div>
                         <div class="flex justify-between items-center border-t border-slate-700 pt-3 mt-2">
                            <span class="text-sm font-bold uppercase text-slate-100">Selling Price</span>
                            <span id="optionFinalPrice" class="text-2xl font-bold text-emerald-400 font-mono">₱0.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="optionDeleteBtn" onclick="deleteProductOption()" class="py-2 px-4 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50">Delete Option</button>
                    <div>
                        <button type="button" onclick="hideProductOptionModal()" class="py-2 px-4 rounded-lg text-sm font-medium border bg-white hover:bg-gray-100">Cancel</button>
                        <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700">Save Option</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NEW: Discount Manager Modal -->
    <div id="discountModal" class="modal">
        <div class="modal-content">
            <form id="discountForm">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-900">Manage Discounts</h3>
                    <button type="button" onclick="hideDiscountModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="discountProductId">
                    <p class="text-sm text-slate-600">Set bulk discounts for: <strong id="discountProductName" class="text-slate-900">...</strong></p>
                    <hr>
                    <p class="text-sm font-semibold text-slate-600">Current Discount Tiers</p>
                    <div id="discountTiersPreviewList" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <!-- Tiers injected here -->
                    </div>
                    <div class="flex gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Buy <span class="text-red-500">*</span></label>
                            <input type="number" id="discountQty" placeholder="e.g. 20" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                            <p class="text-[10px] text-gray-400 mt-1">...or more</p>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-500 mb-1">Get <span class="text-red-500">*</span></label>
                            <input type="number" id="discountPercent" placeholder="e.g. 15" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                             <p class="text-[10px] text-gray-400 mt-1">...% off each</p>
                        </div>
                        <button type="button" onclick="addDiscountTier()" class="flex-none bg-slate-700 hover:bg-slate-600 text-white rounded-lg p-2.5 h-10 self-end"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="hideDiscountModal()" class="py-2 px-4 rounded-lg text-sm font-medium border bg-white hover:bg-gray-100">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-lg text-sm font-medium bg-green-600 text-white hover:bg-green-700">Save Discounts</button>
                </div>
            </form>
        </div>
    </div>


    <!-- SVG Gooey Filter for Blob Buttons -->
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="display: none;">
        <defs>
            <filter id="goo">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
                <feBlend in="SourceGraphic" in2="goo" />
            </filter>
        </defs>
    </svg>


    <!-- === v10.0: THE v8 COMPAT SCRIPT === -->
    <!-- All JS is moved here. No more modules. -->
    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- GLOBAL APP STATE ---
        let app, db, auth, storage;
        let appId, userId;
        let db_suppliers = [], db_inventory = [], db_products = [];
        let inv_currentMode = '', inv_currentOptions = [], inv_currentCategories = [], editing_inv_id = null;
        let editing_sup_id = null;
        let calc_currentProductId = null, calc_currentOptions = [], calc_currentImages = [];
        let calc_originalLoadedProduct = null;
        // --- v1M: Simple Calc State ---
        let quickCalc_currentValue = '0';
        let quickCalc_firstOperand = null;
        let quickCalc_operator = null;
        let quickCalc_waitingForSecondOperand = false;
        // ---
        // --- v10.5: Decoupled State ---
        let calc_bulk_selectedProduct = null;
        let calc_bulk_selectedVariant = null;
        let calc_event_selectedProduct = null;
        let calc_event_selectedVariant = null;
        // ---
        let option_currentMaterials = [], option_currentMargin = 0.50, editing_option_index = null;
        let discount_currentProductId = null, discount_currentTiers = [];
        let modalConfirmCallback = null;
        // --- v11.0: AI Assistant State ---
        let ai_chatHistory = [
            { role: 'ai', content: '<p>Hello, Moses. I\'m SIRIS, your integrated business assistant.</p><p>How can I help you today? You can ask me to do things like:</p><ul><li>"Write a product description for my Artisan Leather Wallet."</li><li>"Brainstorm 5 marketing ideas for a craft fair."</li><li>"What are some good keywords for \'handmade leather\'?"</li></ul>' }
        ];
        const AI_SYSTEM_PROMPT = "You are SIRIS, an expert e-commerce and product pricing assistant. Your user is Moses, a graphic designer and developer in the Philippines who is building an app to price his handmade crafts (like leather wallets). Your tone is intelligent, encouraging, and clear (like Einstein). You are here to help him brainstorm marketing ideas, write compelling product descriptions, find SEO keywords, and solve e-commerce problems. Keep your answers concise, actionable, and formatted with simple HTML (paragraphs, lists) for readability. Do not use markdown.";
        // ---
        
        // --- DOM ELEMENT STATE ---
        let confirmModal, confirmModalTitle, confirmModalText, confirmModalBtn;
        let supForm, supList, supplierModal, supplierModalTitle, supplierDeleteBtn;
        let invForm, invList, inventoryModal, inventoryModalTitle, inventoryDeleteBtn;
        let invUnitEntry, invSizeEntry, invTabUnit, invTabSize;
        let invOptionsPreviewList, invCategoriesPreviewList;
        let calcOptionList, calcImagePreview, calcImageUploadLabel, calcClearBtn, calcCancelBtn;
        let productOptionModal, productOptionForm, optionMaterialSelect, optionDynamicInputs;
        let optionCalcList, optionCalcListContainer, productOptionModalTitle, optionDeleteBtn;
        let savedProductsList;
        let discountsList, discountModal, discountForm, discountTiersPreviewList, discountProductName;
        // --- v10.5: Decoupled Discount Calc DOM ---
        let bulkProductSelect, bulkVariantSelect, bulkQuantityInput, bulkDiscountTier, bulkPuhunan, bulkProfitPerItem, bulkTotalProfit, bulkTotalPrice;
        let eventProductSelect, eventVariantSelect, eventPercentInput, eventPromoInput;
        let eventBasePrice, eventDiscountAmount, eventFinalPrice, eventPuhunan, eventFinalProfit;
        // --- v1M: Simple Calc DOM ---
        let quickCalcDisplay;
        let quickCalcOperationDisplay; // v10.9: Added
        // --- v11.0: AI Assistant DOM ---
        let aiChatHistoryContainer, aiChatForm, aiChatInput, aiLoadingSpinner;
        // ---
        let pages, navButtons;

        // --- GATEKEEPER ---
        let isAuthReady = false;
        let isDomReady = false;
        
        // === v9.7: HOISTING FIX ===
        // All function definitions are moved to the top of the script
        // so they are parsed and hoisted *before* DOMContentLoaded is set.
        
        function checkAppReady() {
            if (isAuthReady && isDomReady) {
                console.log("App is ready! Firing listeners...");
                listenForData(userId);
            } else {
                if (!isAuthReady) console.log("Gatekeeper: Waiting for Auth...");
                if (!isDomReady) console.log("Gatekeeper: Waiting for DOM...");
            }
        }

        // --- UTILITY FUNCTIONS ---
        const formatMoney = (amount) => '₱' + (amount ? amount.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00');

        // --- NAVIGATION ---
        function showPage(pageId) {
            if (!pages) pages = document.querySelectorAll('.page');
            if (!navButtons) navButtons = document.querySelectorAll('nav .blob-btn');
            
            pages.forEach(p => p.classList.remove('active'));
            navButtons.forEach(b => b.classList.remove('active'));
            
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.getElementById(`nav-${pageId}`).classList.add('active');
            
            if (pageId === 'prod-inv') renderSavedProducts();
            if (pageId === 'disc') renderDiscountsPage();
            // v11.0: Render AI chat when page is shown
            if (pageId === 'ai') renderAiChat();
        }

        // --- MODALS (Shared) ---
        function showClearConfirm(type) {
            let title = '', text = '';
            if (type === 'inv') {
                if(db_inventory.length === 0) return;
                title = 'Clear Inventory'; text = 'Are you sure you want to delete all inventory items?';
                modalConfirmCallback = confirmClearInventory;
            } else if (type === 'sup') {
                if(db_suppliers.length === 0) return;
                title = 'Clear Suppliers'; text = 'Are you sure you want to delete all suppliers?';
                modalConfirmCallback = confirmClearSuppliers;
            } else if (type === 'prod') {
                if(db_products.length === 0) return;
                title = 'Clear Saved Products'; text = 'Are you sure you want to delete all saved products? This will also delete associated images from storage.';
                modalConfirmCallback = confirmClearProducts;
            }
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmModal.style.display = 'flex';
        }
        function hideConfirmModal() {
            confirmModal.style.display = 'none';
            modalConfirmCallback = null;
        }

        // =====================================
        // === v1M: SIMPLE CALC FUNCTIONS ===
        // =====================================
        
        // v10.9: Added Operation Display Function
        function updateQuickCalcOperationDisplay() {
            if (!quickCalcOperationDisplay) return;
            if (quickCalc_firstOperand !== null && quickCalc_operator) {
                // Show the pending operation
                quickCalcOperationDisplay.textContent = `${quickCalc_firstOperand} ${quickCalc_operator}`;
            } else {
                // Clear it
                quickCalcOperationDisplay.textContent = '';
            }
        }
        
        function updateQuickCalcDisplay() {
            if (!quickCalcDisplay) return;
            quickCalcDisplay.value = quickCalc_currentValue;
        }
        
        function calcAppend(digit) {
            if (quickCalc_waitingForSecondOperand) {
                quickCalc_currentValue = digit;
                quickCalc_waitingForSecondOperand = false;
            } else {
                quickCalc_currentValue = quickCalc_currentValue === '0' ? digit : quickCalc_currentValue + digit;
            }
            
            // Prevent multiple decimals
            if (digit === '.' && quickCalc_currentValue.split('.').length > 2) {
                quickCalc_currentValue = quickCalc_currentValue.slice(0, -1);
            }
            
            updateQuickCalcDisplay();
        }
        
        function calcSetOperation(nextOperator) {
            const inputValue = parseFloat(quickCalc_currentValue);

            if (quickCalc_firstOperand === null) {
                quickCalc_firstOperand = inputValue;
            } else if (quickCalc_operator) {
                // Perform calculation if there's a pending operation
                const result = performCalculation();
                quickCalc_currentValue = String(result);
                quickCalc_firstOperand = result;
                updateQuickCalcDisplay();
            }

            quickCalc_waitingForSecondOperand = true;
            quickCalc_operator = nextOperator;
            updateQuickCalcOperationDisplay(); // v10.9: Update
        }
        
        function performCalculation() {
            if (quickCalc_firstOperand === null || quickCalc_operator === null) {
                return parseFloat(quickCalc_currentValue);
            }
            
            const secondOperand = parseFloat(quickCalc_currentValue);
            let result = 0;

            switch (quickCalc_operator) {
                case '+': result = quickCalc_firstOperand + secondOperand; break;
                case '-': result = quickCalc_firstOperand - secondOperand; break;
                case '*': result = quickCalc_firstOperand * secondOperand; break;
                case '/': result = quickCalc_firstOperand / secondOperand; break;
                default: return secondOperand;
            }
            
            // Handle floating point issues
            return parseFloat(result.toPrecision(15));
        }

        function calcCompute() {
            const result = performCalculation();
            quickCalc_currentValue = String(result);
            quickCalc_firstOperand = null;
            quickCalc_operator = null;
            quickCalc_waitingForSecondOperand = false;
            updateQuickCalcDisplay();
            updateQuickCalcOperationDisplay(); // v10.9: Update
        }
        
        function calcClear() {
            quickCalc_currentValue = '0';
            quickCalc_firstOperand = null;
            quickCalc_operator = null;
            quickCalc_waitingForSecondOperand = false;
            updateQuickCalcDisplay();
            updateQuickCalcOperationDisplay(); // v10.9: Update
        }

        // ============================
        // === SUPPLIER FUNCTIONS ===
        // ============================
        function showSupplierModal(id = null) {
            supForm.reset();
            if (id) {
                editing_sup_id = id;
                const sup = db_suppliers.find(s => s.id === id);
                supplierModalTitle.textContent = "Edit Supplier";
                supplierDeleteBtn.style.display = 'block';
                document.getElementById('supName').value = sup.name;
                document.getElementById('supContact').value = sup.contact;
                document.getElementById('supAddress').value = sup.address;
                document.getElementById('supDesc').value = sup.desc;
            } else {
                editing_sup_id = null;
                supplierModalTitle.textContent = "Add Supplier";
                supplierDeleteBtn.style.display = 'none';
            }
            supplierModal.style.display = 'flex';
            lucide.createIcons();
        }
        function hideSupplierModal() { supplierModal.style.display = 'none'; editing_sup_id = null; }
        
        async function deleteSupplier() {
            if (!editing_sup_id || !userId) return;
            console.log(`Deleting supplier: ${editing_sup_id}`);
            try {
                // v10.0 FIX: Use v8 syntax
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('suppliers').doc(editing_sup_id);
                await docRef.delete();
                console.log("Supplier deleted");
            } catch (error) { console.error("Error deleting supplier: ", error); }
            hideSupplierModal();
        }

        function renderSuppliers() {
            if (!supList) return;
            supList.innerHTML = '';
            const invSupplierSelect = document.getElementById('invSupplierSelect');
            if (invSupplierSelect) invSupplierSelect.innerHTML = '<option value="">-- Select Supplier --</option>';

            if (db_suppliers.length === 0) {
                supList.innerHTML = '<p class="text-center text-slate-400 pt-10">No suppliers added yet.</p>';
                return;
            }

            db_suppliers.forEach((sup) => {
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-gray-200 p-4 slide-down";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-slate-800">${sup.name}</h4>
                            <p class="text-xs text-slate-500">${sup.contact || 'No contact'}</p>
                            <p class="text-xs text-slate-500">${sup.address || 'No address'}</p>
                        </div>
                        <button onclick="showSupplierModal('${sup.id}')" class="text-blue-500 hover:text-blue-700 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    </div>
                    ${sup.desc ? `<p class="text-sm text-slate-600 mt-2 pt-2 border-t border-gray-100">${sup.desc}</p>` : ''}`;
                supList.appendChild(div);

                if (invSupplierSelect) {
                    const option = document.createElement('option');
                    option.value = sup.id; option.textContent = sup.name;
                    invSupplierSelect.appendChild(option.cloneNode(true));
                }
            });
            lucide.createIcons();
        }
        
        async function confirmClearSuppliers() {
            if (!userId) return;
            console.log("Clearing all suppliers...");
            try {
                // v10.0 FIX: Use v8 syntax
                const querySnapshot = await getSuppliersCol(userId).get();
                const deletePromises = [];
                querySnapshot.forEach((doc) => deletePromises.push(doc.ref.delete()));
                await Promise.all(deletePromises);
                console.log("All suppliers cleared.");
            } catch (error) { console.error("Error clearing suppliers: ", error); }
        }

        // ============================
        // === INVENTORY FUNCTIONS ===
        // ============================
        function showInventoryModal(id = null) {
            invForm.reset();
            inv_currentOptions = []; inv_currentCategories = [];
            renderInvOptionsPreview(); renderInvCategoriesPreview();
            
            const invSupplierSelect = document.getElementById('invSupplierSelect');
            invSupplierSelect.innerHTML = '<option value="">-- Select Supplier --</option>';
            db_suppliers.forEach(sup => {
                const option = document.createElement('option');
                option.value = sup.id; option.textContent = sup.name;
                invSupplierSelect.appendChild(option);
            });
            
            if (id) {
                editing_inv_id = id;
                const item = db_inventory.find(i => i.id === id);
                inventoryModalTitle.textContent = "Edit Material";
                inventoryDeleteBtn.style.display = 'block';
                document.getElementById('invItemName').value = item.name;
                document.getElementById('invSupplierSelect').value = item.supplierId;
                document.getElementById('invItemDesc').value = item.desc;
                setInvMode(item.mode);
                document.getElementById('inv-tab-unit').disabled = true;
                document.getElementById('inv-tab-size').disabled = true;
                if (item.mode === 'unit') {
                    document.getElementById('invUnitTotalCost').value = item.totalCost;
                    document.getElementById('invUnitTotalQty').value = item.totalQty;
                    document.getElementById('invUnitName').value = item.unitName;
                    inv_currentCategories = item.categories ? [...item.categories] : [];
                    renderInvCategoriesPreview();
                } else {
                    inv_currentOptions = [...item.options];
                    renderInvOptionsPreview();
                }
            } else {
                editing_inv_id = null;
                inventoryModalTitle.textContent = "Add Material";
                inventoryDeleteBtn.style.display = 'none';
                document.getElementById('inv-tab-unit').disabled = false;
                document.getElementById('inv-tab-size').disabled = false;
                setInvMode('unit');
            }
            inventoryModal.style.display = 'flex';
            lucide.createIcons();
        }
        
        function hideInventoryModal() { inventoryModal.style.display = 'none'; editing_inv_id = null; }
        
        function setInvMode(mode) {
            inv_currentMode = mode;
            invTabUnit.classList.remove('bg-purple-600', 'text-white', 'border-purple-600', 'bg-white', 'text-slate-600');
            invTabSize.classList.remove('bg-purple-600', 'text-white', 'border-purple-600', 'bg-white', 'text-slate-600');
            if (mode === 'unit') {
                invUnitEntry.style.display = 'block'; invSizeEntry.style.display = 'none';
                invTabUnit.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                invTabSize.classList.add('bg-white', 'text-slate-600');
            } else {
                invUnitEntry.style.display = 'none'; invSizeEntry.style.display = 'block';
                invTabSize.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                invTabUnit.classList.add('bg-white', 'text-slate-600');
            }
        }
        
        window.addInvOption = () => {
            const nameEl = document.getElementById('invOptionName');
            const priceEl = document.getElementById('invOptionPrice');
            if (nameEl.value && priceEl.value > 0) {
                inv_currentOptions.push({ name: nameEl.value, price: parseFloat(priceEl.value) });
                nameEl.value = ''; priceEl.value = ''; nameEl.focus();
                renderInvOptionsPreview();
            }
        }
        function renderInvOptionsPreview() {
            invOptionsPreviewList.innerHTML = ''; if (inv_currentOptions.length === 0) return;
            inv_currentOptions.forEach((opt, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2.5 bg-white rounded-lg border border-purple-100 fade-in';
                div.innerHTML = `
                    <span class="font-medium text-purple-800 text-sm">${opt.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-semibold text-slate-600 text-sm">${formatMoney(opt.price)}</span>
                        <button type="button" onclick="removeInvOption(${index})" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
                    </div>`;
                invOptionsPreviewList.appendChild(div);
            });
            lucide.createIcons();
        }
        window.removeInvOption = (index) => { inv_currentOptions.splice(index, 1); renderInvOptionsPreview(); };
        
        window.addInvCategory = () => {
            const typeEl = document.getElementById('invCategoryType');
            const valueEl = document.getElementById('invCategoryValue');
            if (typeEl.value && valueEl.value) {
                inv_currentCategories.push({ type: typeEl.value, value: valueEl.value });
                typeEl.value = ''; valueEl.value = ''; typeEl.focus();
                renderInvCategoriesPreview();
            }
        }
        function renderInvCategoriesPreview() {
            invCategoriesPreviewList.innerHTML = ''; if (inv_currentCategories.length === 0) return;
            inv_currentCategories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2.5 bg-white rounded-lg border border-purple-100 fade-in';
                div.innerHTML = `
                    <span class="font-medium text-purple-800 text-sm">${cat.type}: ${cat.value}</span>
                    <button type="button" onclick="removeInvCategory(${index})" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button>`;
                invCategoriesPreviewList.appendChild(div);
            });
            lucide.createIcons();
        }
        window.removeInvCategory = (index) => { inv_currentCategories.splice(index, 1); renderInvCategoriesPreview(); };

        async function deleteInventory() {
            if (!editing_inv_id || !userId) return;
            console.log(`Deleting inventory: ${editing_inv_id}`);
            try {
                // v10.0 FIX: Use v8 syntax
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('inventory').doc(editing_inv_id);
                await docRef.delete();
                console.log("Inventory item deleted");
            } catch (error) { console.error("Error deleting inventory item: ", error); }
            hideInventoryModal();
        };
        
        function renderInventory() {
            if (!invList) return;
            invList.innerHTML = '';
            const optionMaterialSelect = document.getElementById('optionMaterialSelect');
            if (optionMaterialSelect) optionMaterialSelect.innerHTML = '<option value="">-- Select a Material --</option>';

            if (db_inventory.length === 0) {
                invList.innerHTML = '<p class="text-center text-slate-400 pt-10">No materials added yet.</p>';
                return;
            }

            db_inventory.forEach((item) => {
                const supplier = db_suppliers.find(s => s.id === item.supplierId);
                let pricingInfo = '';
                if (item.mode === 'unit') {
                    const unitCost = (item.totalCost && item.totalQty) ? item.totalCost / item.totalQty : 0;
                    let categoriesHtml = (item.categories && item.categories.length > 0)
                        ? `<div class="mt-2 flex flex-wrap gap-1">${item.categories.map(cat => `<span class="inline-block bg-gray-100 text-gray-700 text-[10px] px-2 py-0.5 rounded border border-gray-200">${cat.type}: ${cat.value}</span>`).join(' ')}</div>`
                        : '';
                    pricingInfo = `<div class="p-4 border-t border-gray-100">
                                       <span class="text-sm font-semibold text-purple-600 font-mono">${formatMoney(unitCost)}</span>
                                       <span class="text-sm text-slate-500"> / ${item.unitName}</span>
                                       ${categoriesHtml}
                                   </div>`;
                } else {
                    let optionsHtml = item.options.map(opt => `<li class="flex justify-between text-sm"><span class="text-slate-600">${opt.name}</span><span class="font-medium text-slate-800 font-mono">${formatMoney(opt.price)}</span></li>`).join('');
                    pricingInfo = `<div class="p-4 border-t border-gray-100">
                                       <p class="text-xs font-medium text-slate-400 mb-2">PRICES BY OPTION</p>
                                       <ul class="space-y-1">${optionsHtml}</ul>
                                   </div>`;
                }

                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden slide-down";
                div.innerHTML = `
                    <div class="p-4 flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-slate-800">${item.name}</h4>
                            <p class="text-xs text-slate-500">${item.desc || 'No description'}</p>
                            <p class="text-xs font-medium text-blue-600 mt-1">${supplier ? supplier.name : 'No supplier'}</p>
                        </div>
                        <button onclick="showInventoryModal('${item.id}')" class="text-blue-500 hover:text-blue-700 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    </div>
                    ${pricingInfo}`;
                invList.appendChild(div);

                if (optionMaterialSelect) {
                    const option = document.createElement('option');
                    option.value = item.id; option.textContent = item.name;
                    optionMaterialSelect.appendChild(option);
                }
            });
            lucide.createIcons();
        }

        async function confirmClearInventory() {
            if (!userId) return;
            console.log("Clearing all inventory...");
            try {
                // v10.0 FIX: Use v8 syntax
                const querySnapshot = await getInventoryCol(userId).get();
                const deletePromises = [];
                querySnapshot.forEach((doc) => deletePromises.push(doc.ref.delete()));
                await Promise.all(deletePromises);
                console.log("All inventory cleared.");
            } catch (error) { console.error("Error clearing inventory: ", error); }
        }

        // =====================================
        // === CALCULATOR FUNCTIONS ===
        // =====================================
        
        async function handleImageUpload(event) {
            const files = event.target.files; if (!files) return;
            const remainingSlots = 5 - calc_currentImages.length;
            if (files.length > remainingSlots) console.warn(`You can only upload ${remainingSlots} more images.`);
            
            const filesToUpload = Array.from(files).slice(0, remainingSlots);
            
            const loadingElements = filesToUpload.map((file, i) => {
                const id = `loading-${i}-${Date.now()}`;
                const div = document.createElement('div');
                div.id = id; div.className = "image-preview-item";
                div.innerHTML = `<i data-lucide="loader" class="image-upload-loading w-6 h-6"></i>`;
                calcImagePreview.appendChild(div);
                return { id, file };
            });
            lucide.createIcons(); checkImageUploadLimit();

            for (const el of loadingElements) {
                const result = await uploadFileToStorage(el.file);
                if (result) {
                    calc_currentImages.push(result);
                    const div = document.getElementById(el.id);
                    if (div) {
                        div.innerHTML = `
                            <img src="${result.url}" alt="Product image" class="image-preview-img">
                            <button type="button" onclick="removeCalcImage(${calc_currentImages.length - 1})" class="image-preview-remove">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>`;
                        lucide.createIcons();
                    }
                } else {
                    const div = document.getElementById(el.id);
                    if (div) div.remove();
                }
            }
            event.target.value = null; checkImageUploadLimit();
        }
        
        window.removeCalcImage = async (index) => {
            const image = calc_currentImages[index]; if (!image) return;
            
            // --- v10.1: LOGIC CHANGE ---
            // We don't delete from storage here. We only remove from the array.
            // The save/cancel functions will handle storage cleanup.
            calc_currentImages.splice(index, 1);
            renderCalcImagePreview();
        }
        
        function renderCalcImagePreview() {
            if (!calcImagePreview) return;
            calcImagePreview.innerHTML = '';
            calc_currentImages.forEach((image, index) => {
                const div = document.createElement('div');
                div.className = "image-preview-item";
                div.innerHTML = `
                    <img src="${image.url}" alt="Product image" class="image-preview-img">
                    <button type="button" onclick="removeCalcImage(${index})" class="image-preview-remove">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>`;
                calcImagePreview.appendChild(div);
            });
            lucide.createIcons(); checkImageUploadLimit();
        }
        
        function checkImageUploadLimit() {
            if (!calcImageUploadLabel) return;
            if (calc_currentImages.length >= 5) calcImageUploadLabel.style.display = 'none';
            else calcImageUploadLabel.style.display = 'flex';
        }

        async function saveProductToDb() {
            const name = document.getElementById('calcProductName').value;
            if (!name) { console.error("Please enter a Product Name."); return; }
            if (calc_currentOptions.length === 0) { console.error("Please add at least one Product Option."); return; }
            if (!userId) { console.error("No user ID. Cannot save."); return; }
            
            const productData = {
                name: name,
                desc: document.getElementById('calcProductDesc').value,
                tags: document.getElementById('calcProductTags').value,
                platform: document.getElementById('calcProductPlatform').value,
                keywords: document.getElementById('calcProductKeywords').value,
                images: [...calc_currentImages],
                options: [...calc_currentOptions]
            };
            
            try {
                if (calc_currentProductId) {
                    console.log(`Updating product: ${calc_currentProductId}`);
                    
                    // --- v10.1: BONUS FIX - Clean up deleted images ---
                    // Compare the *original* images with the *new* ones. Delete any that were removed.
                    const originalImages = calc_originalLoadedProduct.images || [];
                    const newImagePaths = productData.images.map(img => img.path);
                    const imagesToDelete = originalImages.filter(orig => !newImagePaths.includes(orig.path));
                    
                    if (imagesToDelete.length > 0) {
                        console.log(`Cleaning up ${imagesToDelete.length} removed images...`);
                        const deletePromises = imagesToDelete.map(img => deleteFileFromStorage(img.path));
                        await Promise.all(deletePromises);
                    }
                    // --- End Bonus Fix ---
                    
                    // v10.0 FIX: Use v8 syntax
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('products').doc(calc_currentProductId);
                    const existingProd = db_products.find(p => p.id === calc_currentProductId);
                    const existingDiscounts = existingProd.discounts || [];
                    await docRef.update({ ...productData, discounts: existingDiscounts });
                } else {
                    console.log("Saving new product...");
                    productData.discounts = [];
                    // v10.0 FIX: Use v8 syntax
                    await getProductsCol(userId).add({ ...productData });
                }
                console.log("Product saved successfully.");
            } catch (error) { console.error("Error saving product: ", error); }
            
            clearCalculator(); showPage('prod-inv');
        }
        
        function loadProductToCalculator(id) {
            const product = db_products.find(p => p.id === id); if (!product) return;
            clearCalculator(); // Clear first to ensure no old data/images are kept
            
            // --- v10.1: Create the "snapshot" for cancel ---
            // We use JSON.parse(JSON.stringify) for a deep clone, not a reference
            calc_originalLoadedProduct = JSON.parse(JSON.stringify(product));
            
            calc_currentProductId = product.id;
            document.getElementById('calcProductName').value = product.name;
            document.getElementById('calcProductDesc').value = product.desc;
            document.getElementById('calcProductTags').value = product.tags;
            document.getElementById('calcProductPlatform').value = product.platform;
            document.getElementById('calcProductKeywords').value = product.keywords;
            
            // Deep clone images and options too
            calc_currentImages = product.images ? JSON.parse(JSON.stringify(product.images)) : [];
            calc_currentOptions = JSON.parse(JSON.stringify(product.options));
            
            renderCalcImagePreview();
            renderCalcOptionsList();
            
            // --- v10.1: Toggle buttons ---
            calcClearBtn.style.display = 'none';
            calcCancelBtn.style.display = 'block';
            
            showPage('calc');
        }
        
        async function cancelCalculatorUpdate() {
            if (!calc_originalLoadedProduct) {
                // This shouldn't happen if buttons are toggled, but good to check
                clearCalculator();
                return;
            }
            
            console.log("Canceling update, reverting to snapshot...");
            
            // --- v10.1: Clean up *newly uploaded* images ---
            const originalImagePaths = (calc_originalLoadedProduct.images || []).map(img => img.path);
            const currentImagePaths = calc_currentImages.map(img => img.path);
            
            // Find images that are in the *current* state but not in the *original* state
            const newImagesToDelete = calc_currentImages.filter(img => !originalImagePaths.includes(img.path));
            
            if (newImagesToDelete.length > 0) {
                console.log(`Cleaning up ${newImagesToDelete.length} newly-added images...`);
                const deletePromises = newImagesToDelete.map(img => deleteFileFromStorage(img.path));
                await Promise.all(deletePromises);
            }
            
            // --- v10.2: Clear the form and switch pages ---
            clearCalculator(); // This resets all state, forms, and buttons
            showPage('prod-inv'); // Go back to the product list
        }
        
        function clearCalculator() {
            // --- v10.1: Clear snapshot state ---
            calc_originalLoadedProduct = null;
            
            calc_currentProductId = null;
            calc_currentOptions = [];
            
            if (calc_currentImages.length > 0) {
                console.log("Clearing images from calculator state... (Storage clear handled by save/cancel)");
                // --- v10.1: LOGIC CHANGE ---
                const originalImagePaths = (calc_originalLoadedProduct ? calc_originalLoadedProduct.images : []).map(img => img.path);
                const newImagesToDelete = calc_currentImages.filter(img => !originalImagePaths.includes(img.path));
                
                if (newImagesToDelete.length > 0) {
                     console.log(`Clearing ${newImagesToDelete.length} un-saved images from storage...`);
                    const deletePromises = newImagesToDelete.map(img => deleteFileFromStorage(img.path));
                    Promise.all(deletePromises).then(() => console.log("Calculator images cleared from storage"));
                }
            }
            
            calc_currentImages = [];
            document.getElementById('calcProductName').value = '';
            document.getElementById('calcProductDesc').value = '';
            document.getElementById('calcProductTags').value = '';
            document.getElementById('calcProductPlatform').value = '';
            document.getElementById('calcProductKeywords').value = '';
            renderCalcOptionsList();
            renderCalcImagePreview();
            
            // --- v10.1: Toggle buttons ---
            calcClearBtn.style.display = 'block';
            calcCancelBtn.style.display = 'none';
        }
        
        function renderCalcOptionsList() {
            if (!calcOptionList) return;
            calcOptionList.innerHTML = '';
            if (calc_currentOptions.length === 0) {
                calcOptionList.innerHTML = '<p class="text-center text-sm text-slate-400 py-4">No options added yet. Click "Add Option" to get started.</p>';
                return;
            }
            
            calc_currentOptions.forEach((opt, index) => {
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-gray-200 p-4 slide-down";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-slate-800">${opt.name}</h4>
                            <p class="text-xs text-slate-500">${opt.items.length} materials</p>
                        </div>
                        <div class="text-right">
                             <p class="text-lg font-bold text-blue-600 font-mono">${formatMoney(opt.finalPrice)}</p>
                             <button onclick="showProductOptionModal(${index})" class="text-xs text-blue-500 hover:text-blue-700 mt-1">Edit</button>
                        </div>
                    </div>`;
                calcOptionList.appendChild(div);
            });
            lucide.createIcons();
        }

        // =====================================
        // === PRODUCT OPTION MODAL ===
        // =====================================
        
        function showProductOptionModal(index = null) {
            productOptionForm.reset();
            option_currentMaterials = [];
            
            const optionMaterialSelect = document.getElementById('optionMaterialSelect');
            optionMaterialSelect.innerHTML = '<option value="">-- Select a Material --</option>';
            db_inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; option.textContent = item.name;
                optionMaterialSelect.appendChild(option);
            });
            
            if (index !== null) {
                editing_option_index = index;
                const opt = calc_currentOptions[index];
                productOptionModalTitle.textContent = "Edit Product Option";
                optionDeleteBtn.style.display = 'block';
                document.getElementById('optionName').value = opt.name;
                document.getElementById('optionMargin').value = opt.margin;
                option_currentMaterials = [...opt.items];
            } else {
                editing_option_index = null;
                productOptionModalTitle.textContent = "Add Product Option";
                optionDeleteBtn.style.display = 'none';
                document.getElementById('optionMargin').value = "0.50";
            }
            
            optionDynamicInputs.innerHTML = '';
            optionDynamicInputs.style.display = 'none';
            renderOptionMaterialsList();
            productOptionModal.style.display = 'flex';
            lucide.createIcons();
        }
        
        function hideProductOptionModal() { productOptionModal.style.display = 'none'; editing_option_index = null; }
        
        window.deleteProductOption = () => {
            if (editing_option_index === null) return;
            calc_currentOptions.splice(editing_option_index, 1);
            hideProductOptionModal(); renderCalcOptionsList();
        }
        
        function addMaterialToOption() {
            const materialId = optionMaterialSelect.value; if (!materialId) return;
            const item = db_inventory.find(i => i.id === materialId);
            let cost = 0, name = item.name;

            if (item.mode === 'unit') {
                const qty = parseFloat(document.getElementById('optionUnitQty').value);
                if (!qty || qty <= 0) { console.error('Please enter a valid quantity.'); return; }
                const unitCost = (item.totalCost && item.totalQty) ? item.totalCost / item.totalQty : 0;
                cost = unitCost * qty;
                name += ` (${qty} ${item.unitName})`;
            } else {
                const select = document.getElementById('optionSizeSelect');
                cost = parseFloat(select.value);
                name += ` (${select.options[select.selectedIndex].text.split(' (')[0]})`;
            }

            option_currentMaterials.push({ id: crypto.randomUUID(), name, cost });
            renderOptionMaterialsList();
            optionMaterialSelect.value = '';
            optionDynamicInputs.innerHTML = '';
            optionDynamicInputs.style.display = 'none';
        }
        
        function renderOptionMaterialsList() {
            optionCalcList.innerHTML = '';
            if (option_currentMaterials.length === 0) {
                optionCalcListContainer.style.display = 'none';
                updateOptionTotals(); return;
            }
            optionCalcListContainer.style.display = 'block';

            option_currentMaterials.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "p-3 flex justify-between items-center hover:bg-gray-50 fade-in";
                div.innerHTML = `
                    <span class="font-medium text-slate-800 text-sm">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold text-slate-700 text-sm">${formatMoney(item.cost)}</span>
                        <button type="button" onclick="deleteOptionMaterial(${index})" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
                    </div>`;
                optionCalcList.appendChild(div);
            });
            lucide.createIcons(); updateOptionTotals();
        }
        
        window.deleteOptionMaterial = (index) => { option_currentMaterials.splice(index, 1); renderOptionMaterialsList(); };

        function updateOptionTotals() {
            const margin = parseFloat(document.getElementById('optionMargin').value) || 0.50;
            const totalCost = option_currentMaterials.reduce((sum, item) => sum + item.cost, 0);
            const profit = totalCost * margin;
            const finalPrice = totalCost + profit;
            document.getElementById('optionTotalCost').textContent = formatMoney(totalCost);
            document.getElementById('optionMarginLabel').textContent = `${(margin * 100).toFixed(0)}%`;
            document.getElementById('optionProfit').textContent = formatMoney(profit);
            document.getElementById('optionFinalPrice').textContent = formatMoney(finalPrice);
        }
        
        // =====================================
        // === PRODUCT INVENTORY FUNCTIONS ===
        // =====================================
        
        function renderSavedProducts() {
            if (!savedProductsList) return;
            savedProductsList.innerHTML = '';
            if (db_products.length === 0) {
                savedProductsList.innerHTML = '<p class="text-center text-slate-400 pt-10">No products saved yet. Go to the Calculator to build one!</p>';
                return;
            }

            db_products.forEach((prod) => {
                // --- v10.6: Add Margin % to Product List ---
                let optionsHtml = prod.options.map(opt => 
                    `<li class="flex justify-between items-center text-sm py-2 border-b border-gray-100 last:border-b-0">
                        <div>
                            <span class="text-slate-600 font-medium">${opt.name}</span>
                            <div class="text-xs mt-1">
                                <span class="text-slate-400">Cost:</span> <span class="text-slate-500 font-mono">${formatMoney(opt.totalCost)}</span>
                                <span class="text-slate-400 ml-3">Profit:</span> <span class="text-green-600 font-mono">${formatMoney(opt.profit)}</span>
                                <span class="text-slate-400 ml-3">@</span> <span class="text-blue-600 font-mono">${(opt.margin * 100).toFixed(0)}% Margin</span>
                            </div>
                        </div>
                        <span class="font-bold text-slate-800 font-mono text-base">${formatMoney(opt.finalPrice)}</span>
                    </li>`
                ).join('');
                // --- End v10.6 ---
                
                let imagesHtml = (prod.images && prod.images.length > 0)
                    ? `<div class="flex gap-2 overflow-x-auto p-4 pb-0">${prod.images.map(img => `<img src="${img.url}" alt="${prod.name}" class="w-16 h-16 rounded-md object-cover border border-gray-200" onerror="this.src='https://placehold.co/64x64/e0e7ff/6366f1?text=IMG'">`).join('')}</div>`
                    : `<div class="flex gap-2 overflow-x-auto p-4 pb-0"><img src="https://placehold.co/64x64/f1f5f9/94a3b8?text=No+Image" alt="No image" class="w-16 h-16 rounded-md object-cover border border-gray-200"></div>`;
                
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden slide-down";
                div.innerHTML = `
                    ${imagesHtml}
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-slate-800">${prod.name}</h4>
                                <p class="text-xs text-slate-500">${prod.desc || 'No description'}</p>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${prod.tags ? prod.tags.split(',').map(t => `<span class="text-[10px] bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full">${t.trim()}</span>`).join('') : ''}
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 flex-shrink-0 ml-4">
                                <button onclick="loadProductToCalculator('${prod.id}')" class="text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-md">Load to Calculator</button>
                                <button onclick="deleteProduct('${prod.id}')" class="text-xs text-red-400 hover:text-red-600 p-1">Delete Product</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 border-t border-gray-100 p-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs font-medium text-slate-400 uppercase">Priced Options</p>
                            <p class="text-xs font-medium text-slate-400 uppercase">Retail Price</p>
                        </div>
                        <ul class="space-y-0">${optionsHtml}</ul>
                    </div>`;
                // --- End v10.5 Template Update ---
                savedProductsList.appendChild(div);
            });
            lucide.createIcons();
        }
        
        async function deleteProduct(id) {
            if (!id || !userId) return;
            console.log(`Deleting product: ${id}`);
            const product = db_products.find(p => p.id === id);
            if (product && product.images && product.images.length > 0) {
                console.log("Deleting product images from storage...");
                const deletePromises = product.images.map(img => deleteFileFromStorage(img.path));
                await Promise.all(deletePromises);
            }
            try {
                // v10.0 FIX: Use v8 syntax
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('products').doc(id);
                await docRef.delete();
                console.log("Product deleted.");
            } catch (error) { console.error("Error deleting product: ", error); }
        }
        
        async function confirmClearProducts() {
            if (!userId) return;
            console.log("Clearing all products...");
            try {
                const deletePromises = [];
                db_products.forEach(prod => {
                    if (prod.images && prod.images.length > 0) {
                        prod.images.forEach(img => deletePromises.push(deleteFileFromStorage(img.path)));
                    }
                });
                console.log(`Deleting ${deletePromises.length} images...`);
                await Promise.all(deletePromises);
                
                // v10.0 FIX: Use v8 syntax
                const querySnapshot = await getProductsCol(userId).get();
                const deleteDocPromises = [];
                querySnapshot.forEach((doc) => deleteDocPromises.push(doc.ref.delete()));
                console.log(`Deleting ${deleteDocPromises.length} product docs...`);
                await Promise.all(deleteDocPromises);
                console.log("All products cleared.");
            } catch (error) { console.error("Error clearing products: ", error); }
        }
        
        
        // =====================================
        // === DISCOUNTS PAGE (v10.5) ===
        // =====================================
        
        function renderDiscountsPage() {
            if (!discountsList || !bulkProductSelect || !eventProductSelect) return;
            discountsList.innerHTML = '';
            
            // v10.5: Populate BOTH Product Dropdowns
            bulkProductSelect.innerHTML = '<option value="">-- Select Product --</option>';
            eventProductSelect.innerHTML = '<option value="">-- Select Product --</option>';
            
            if (db_products.length === 0) {
                discountsList.innerHTML = '<p class="text-center text-slate-400 pt-10">No products found. Add products in the Calculator first.</p>';
                runBulkCalculator(); // Reset calculators
                runEventSaleCalculator();
                return;
            }

            db_products.forEach((prod) => {
                // Populate dropdowns
                const option = document.createElement('option');
                option.value = prod.id; option.textContent = prod.name;
                bulkProductSelect.appendChild(option.cloneNode(true));
                eventProductSelect.appendChild(option.cloneNode(true));
            
                // Render the management list
                let discountsHtml = (prod.discounts && prod.discounts.length > 0)
                    ? prod.discounts.sort((a, b) => a.qty - b.qty).map(d => `<span class="inline-block bg-emerald-50 text-emerald-700 text-xs font-medium px-2 py-1 rounded-full border border-emerald-100">Buy ${d.qty}+, get ${d.percent}% off</span>`).join(' ')
                    : '<span class="text-xs text-slate-400">No discounts set.</span>';

                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm border border-gray-200 p-4 slide-down";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-slate-800">${prod.name}</h4>
                            <p class="text-xs text-slate-500">${prod.options.length} priced option(s)</p>
                        </div>
                        <button onclick="showDiscountModal('${prod.id}')" class="text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg flex items-center gap-2 transition-all">
                            <i data-lucide="settings-2" class="w-4 h-4"></i> Manage
                        </button>
                    </div>
                    <div class="border-t border-gray-100 mt-3 pt-3 flex flex-wrap gap-2">
                        ${discountsHtml}
                    </div>`;
                discountsList.appendChild(div);
            });
            
            runBulkCalculator(); // Reset calculators
            runEventSaleCalculator();
            lucide.createIcons();
        }
        
        function showDiscountModal(id) {
            const product = db_products.find(p => p.id === id); if (!product) return;
            discountForm.reset();
            discount_currentProductId = id;
            discount_currentTiers = product.discounts ? [...product.discounts] : [];
            discountProductName.textContent = product.name;
            renderDiscountTiersList();
            discountModal.style.display = 'flex';
            lucide.createIcons();
        }
        
        function hideDiscountModal() { discountModal.style.display = 'none'; discount_currentProductId = null; discount_currentTiers = []; }
        
        window.addDiscountTier = () => {
            const qtyEl = document.getElementById('discountQty');
            const percentEl = document.getElementById('discountPercent');
            const qty = parseInt(qtyEl.value), percent = parseInt(percentEl.value);
            
            if (qty > 0 && percent > 0) {
                if (discount_currentTiers.some(t => t.qty === qty)) { console.warn("A discount for this quantity already exists."); return; }
                discount_currentTiers.push({ qty, percent });
                discount_currentTiers.sort((a, b) => a.qty - b.qty);
                renderDiscountTiersList();
                qtyEl.value = ''; percentEl.value = '';
            }
        }
        
        function renderDiscountTiersList() {
            discountTiersPreviewList.innerHTML = '';
            if (discount_currentTiers.length === 0) {
                 discountTiersPreviewList.innerHTML = '<p class="text-center text-sm text-slate-400 py-2">No discount tiers added.</p>';
                return;
            }
            discount_currentTiers.forEach((tier, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2.5 bg-white rounded-lg border border-emerald-100 fade-in';
                div.innerHTML = `
                    <span class="font-medium text-emerald-800 text-sm">Buy ${tier.qty} or more, get ${tier.percent}% off</span>
                    <button type="button" onclick="removeDiscountTier(${index})" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button>`;
                discountTiersPreviewList.appendChild(div);
            });
            lucide.createIcons();
        }
        
        window.removeDiscountTier = (index) => { discount_currentTiers.splice(index, 1); renderDiscountTiersList(); }
        
        // --- v10.5: DECOUPLED SALES ENGINE FUNCTIONS ---
        
        // Handler for Bulk Product dropdown
        function handleBulkProductChange() {
            const prodId = bulkProductSelect.value;
            bulkVariantSelect.innerHTML = '<option value="">-- Select Variant --</option>';
            if (!prodId) {
                calc_bulk_selectedProduct = null;
                runBulkCalculator();
                return;
            }
            calc_bulk_selectedProduct = db_products.find(p => p.id === prodId);
            if (calc_bulk_selectedProduct && calc_bulk_selectedProduct.options) {
                calc_bulk_selectedProduct.options.forEach((opt, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Use index as value
                    option.textContent = `${opt.name} (${formatMoney(opt.finalPrice)})`;
                    bulkVariantSelect.appendChild(option);
                });
            }
            runBulkCalculator();
        }
        
        // Handler for Event Sale Product dropdown
        function handleEventProductChange() {
            const prodId = eventProductSelect.value;
            eventVariantSelect.innerHTML = '<option value="">-- Select Variant --</option>';
            if (!prodId) {
                calc_event_selectedProduct = null;
                runEventSaleCalculator();
                return;
            }
            calc_event_selectedProduct = db_products.find(p => p.id === prodId);
            if (calc_event_selectedProduct && calc_event_selectedProduct.options) {
                calc_event_selectedProduct.options.forEach((opt, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Use index as value
                    option.textContent = `${opt.name} (${formatMoney(opt.finalPrice)})`;
                    eventVariantSelect.appendChild(option);
                });
            }
            runEventSaleCalculator();
        }

        // Util to find the best discount for a given quantity
        function findBestDiscount(discounts, quantity) {
            if (!discounts || discounts.length === 0 || quantity === 0) return null;
            const eligibleDiscounts = discounts.filter(d => quantity >= d.qty);
            if (eligibleDiscounts.length === 0) return null;
            // Find the discount with the highest "qty" threshold that is met
            return eligibleDiscounts.reduce((best, current) => (current.qty > best.qty ? current : best), eligibleDiscounts[0]);
        }
        
        // Runs all calculations for the BULK card
        function runBulkCalculator() {
            if (!calc_bulk_selectedProduct || bulkVariantSelect.value === "") {
                // Reset all fields
                calc_bulk_selectedVariant = null;
                bulkDiscountTier.textContent = "N/A";
                bulkPuhunan.textContent = "₱0.00";
                bulkProfitPerItem.textContent = "₱0.00";
                bulkTotalProfit.textContent = "₱0.00";
                bulkTotalPrice.textContent = "₱0.00";
                return;
            }
            
            const variantIndex = parseInt(bulkVariantSelect.value);
            const variant = calc_bulk_selectedProduct.options[variantIndex];
            const quantity = parseInt(bulkQuantityInput.value) || 0;
            
            const basePrice = variant.finalPrice;
            const puhunan = variant.totalCost;
            
            // 1. Bulk Calculation
            const discount = findBestDiscount(calc_bulk_selectedProduct.discounts, quantity);
            const discountPercent = discount ? discount.percent / 100 : 0;
            const newPricePerItem = basePrice * (1 - discountPercent);
            const newProfitPerItem = newPricePerItem - puhunan;
            const totalBulkPrice = newPricePerItem * quantity;
            const totalBulkProfit = newProfitPerItem * quantity;
            
            // 2. Update UI
            bulkDiscountTier.textContent = discount ? `${discount.percent}% @ ${discount.qty}+` : 'N/A';
            bulkPuhunan.textContent = formatMoney(puhunan);
            bulkProfitPerItem.textContent = formatMoney(newProfitPerItem);
            bulkTotalProfit.textContent = formatMoney(totalBulkProfit);
            bulkTotalPrice.textContent = formatMoney(totalBulkPrice);
        }
        
        // Runs all calculations for the EVENT SALE card
        function runEventSaleCalculator() {
            if (!calc_event_selectedProduct || eventVariantSelect.value === "") {
                // Reset all fields
                calc_event_selectedVariant = null;
                eventBasePrice.textContent = "₱0.00";
                eventDiscountAmount.textContent = "₱0.00";
                eventFinalPrice.textContent = "₱0.00";
                eventPuhunan.textContent = "₱0.00";
                eventFinalProfit.textContent = "₱0.00";
                return;
            }
            
            const variantIndex = parseInt(eventVariantSelect.value);
            const variant = calc_event_selectedProduct.options[variantIndex];
            const eventPercent = parseFloat(eventPercentInput.value) || 0;
            
            const basePrice = variant.finalPrice;
            const puhunan = variant.totalCost;
            
            // 1. Event Sale Calculation
            const eventDiscountAmountNum = basePrice * (eventPercent / 100);
            const finalPrice = basePrice - eventDiscountAmountNum;
            const finalProfitPerItem = finalPrice - puhunan;
            
            // 2. Update UI
            eventBasePrice.textContent = formatMoney(basePrice);
            eventDiscountAmount.textContent = `-${formatMoney(eventDiscountAmountNum)}`;
            eventFinalPrice.textContent = formatMoney(finalPrice);
            eventPuhunan.textContent = formatMoney(puhunan);
            eventFinalProfit.textContent = formatMoney(finalProfitPerItem);
        }
        
        
        // =====================================
        // === v11.0: AI ASSISTANT FUNCTIONS ===
        // =====================================
        
        // Renders the current chat history to the DOM
        function renderAiChat() {
            if (!aiChatHistoryContainer) return;
            aiChatHistoryContainer.innerHTML = ''; // Clear existing
            
            ai_chatHistory.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
                bubble.innerHTML = msg.content; // Use innerHTML to render formatted AI responses
                aiChatHistoryContainer.appendChild(bubble);
            });
            
            // Scroll to bottom
            aiChatHistoryContainer.scrollTop = aiChatHistoryContainer.scrollHeight;
        }

        // Handles the chat form submission
        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const prompt = aiChatInput.value.trim();
            if (!prompt) return;
            
            aiChatInput.value = ''; // Clear input
            aiLoadingSpinner.style.display = 'block'; // Show spinner
            
            // Add user message and render
            ai_chatHistory.push({ role: 'user', content: prompt });
            renderAiChat();
            
            try {
                // Call the Gemini API
                const aiResponse = await callGeminiApi(prompt);
                ai_chatHistory.push({ role: 'ai', content: aiResponse });
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                ai_chatHistory.push({ role: 'ai', content: `<p>Sorry, I ran into an error. Please try again.</p><p><small>${error.message}</small></p>` });
            }
            
            aiLoadingSpinner.style.display = 'none'; // Hide spinner
            renderAiChat(); // Render final AI response
        }

        // Fetches from Gemini API with exponential backoff
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // Don't retry on client errors (4xx)
                    if (response.status >= 400 && response.status < 500) {
                        throw new Error(`Client error: ${response.status} ${response.statusText}`);
                    }
                    // Retry on server errors (5xx)
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // The main API call function
        async function callGeminiApi(prompt) {
            const apiKey = "AIzaSyB17RV27uPL_6lim-UVod4AEMvmDy94pRA"; // Per instructions, leave blank
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: AI_SYSTEM_PROMPT }]
                },
            };
            
            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Safely extract the text
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                // Simple conversion for newlines to <p> tags for better HTML rendering
                return text.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');
            } else {
                throw new Error("Invalid response from AI. No text content found.");
            }
        }

        
        // --- STORAGE FUNCTIONS (v10.0 - v8 Compat Syntax) ---
        async function uploadFileToStorage(file) {
            if (!userId) { console.error("User not authenticated. Cannot upload file."); return null; }
            const filePath = `artifacts/${appId}/users/${userId}/uploads/${crypto.randomUUID()}-${file.name}`;
            const fileRef = storage.ref(filePath); // v8 syntax
            try {
                console.log(`Uploading file to: ${filePath}`);
                const snapshot = await fileRef.put(file); // v8 syntax
                const url = await snapshot.ref.getDownloadURL(); // v8 syntax
                console.log("File upload success, URL:", url);
                return { url, path: filePath };
            } catch (error) { console.error("Error uploading file: ", error); return null; }
        }
        async function deleteFileFromStorage(path) {
             if (!path) return;
             try {
                console.log(`Deleting file from: ${path}`);
                const fileRef = storage.ref(path); // v8 syntax
                await fileRef.delete(); // v8 syntax
             } catch (error) { console.warn("Could not delete file: ", error); }
        }
        
        // --- FIRESTORE HELPERS (v10.0 - v8 Compat Syntax) ---
        const getSuppliersCol = (uid) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('suppliers'); // v8 syntax
        const getInventoryCol = (uid) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('inventory'); // v8 syntax
        const getProductsCol = (uid) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('products'); // v8 syntax

        // --- DATA LISTENING (v10.0 - v8 Compat Syntax) ---
        function listenForData(uid) {
            if (!uid) { console.error("listenForData called with no UID."); return; }
            console.log("Attaching Firestore listeners for user:", uid);
            
            getSuppliersCol(uid).onSnapshot((snapshot) => { // v8 syntax
                console.log(`Received supplier snapshot: ${snapshot.docs.length} docs`);
                db_suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSuppliers(); renderInventory();
            }, (error) => console.error("Error listening for suppliers:", error));

            getInventoryCol(uid).onSnapshot((snapshot) => { // v8 syntax
                console.log(`Received inventory snapshot: ${snapshot.docs.length} docs`);
                db_inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory();
            }, (error) => console.error("Error listening for inventory:", error));

            getProductsCol(uid).onSnapshot((snapshot) => { // v8 syntax
                console.log(`Received product snapshot: ${snapshot.docs.length} docs`);
                db_products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSavedProducts(); renderDiscountsPage();
            }, (error) => console.error("Error listening for products:", error));
        }
        
        // --- AUTHENTICATION (v10.0 - v8 Compat Syntax) ---
        async function signIn() {
            try {
                console.log("Attempting anonymous sign in...");
                await firebase.auth().signInAnonymously();
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                alert("Authentication failed. Please check Firebase configuration.");
            }
        }
        
        async function initializeAuth() {
            firebase.auth().onAuthStateChanged((user) => { // Removed async
                if (user) {
                    console.log("Auth is ready! User:", user.uid);
                    userId = user.uid;
                    isAuthReady = true;
                    checkAppReady();
                } else {
                    console.log("User is signed out, attempting sign in...");
                    userId = null;
                    isAuthReady = false;
                    signIn();
                }
            });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM is ready!");
            isDomReady = true;
            
            // --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyBqgJn9O_ad7qIlMJktfpmtE1ismL0It-k",
  authDomain: "inventory-pro-e9083.firebaseapp.com",
  projectId: "inventory-pro-e9083",
  storageBucket: "inventory-pro-e9083.firebasestorage.app",
  messagingSenderId: "367601056529",
  appId: "1:367601056529:web:fff26409a8e2abddbfeab0",
  measurementId: "G-CHF0HQ1ED9"
};
            
            if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
                console.error("Firebase config is not set. Please paste your config object.");
                alert("CRITICAL ERROR: Firebase config is not set. App cannot start.");
                return;
            }
            appId = firebaseConfig.projectId || 'default-app-id';

            // --- INITIALIZE FIREBASE & GLOBALS (v10.0 - v8 Compat Syntax) ---
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            
            // --- ASSIGN ALL DOM ELEMENTS ---
            confirmModal = document.getElementById('confirmModal');
            confirmModalTitle = document.getElementById('confirmModalTitle');
            confirmModalText = document.getElementById('confirmModalText');
            confirmModalBtn = document.getElementById('confirmModalBtn');
            supForm = document.getElementById('supForm');
            supList = document.getElementById('supList');
            supplierModal = document.getElementById('supplierModal');
            supplierModalTitle = document.getElementById('supplierModalTitle');
            supplierDeleteBtn = document.getElementById('supplierDeleteBtn');
            invForm = document.getElementById('invForm');
            invList = document.getElementById('invList');
            inventoryModal = document.getElementById('inventoryModal');
            inventoryModalTitle = document.getElementById('inventoryModalTitle');
            inventoryDeleteBtn = document.getElementById('inventoryDeleteBtn');
            invUnitEntry = document.getElementById('invUnitEntry');
            invSizeEntry = document.getElementById('invSizeEntry');
            invTabUnit = document.getElementById('inv-tab-unit');
            invTabSize = document.getElementById('inv-tab-size');
            invOptionsPreviewList = document.getElementById('invOptionsPreviewList');
            invCategoriesPreviewList = document.getElementById('invCategoriesPreviewList');
            calcOptionList = document.getElementById('calcOptionList');
            calcImagePreview = document.getElementById('calcImagePreview');
            calcImageUploadLabel = document.getElementById('calcImageUploadLabel');
            calcClearBtn = document.getElementById('calcClearBtn');
            calcCancelBtn = document.getElementById('calcCancelBtn');
            productOptionModal = document.getElementById('productOptionModal');
            productOptionForm = document.getElementById('productOptionForm');
            optionMaterialSelect = document.getElementById('optionMaterialSelect');
            optionDynamicInputs = document.getElementById('optionDynamicInputs');
            optionCalcList = document.getElementById('optionCalcList');
            optionCalcListContainer = document.getElementById('optionCalcListContainer');
            productOptionModalTitle = document.getElementById('productOptionModalTitle');
            optionDeleteBtn = document.getElementById('optionDeleteBtn');
            savedProductsList = document.getElementById('savedProductsList');
            discountsList = document.getElementById('discountsList');
            discountModal = document.getElementById('discountModal');
            discountForm = document.getElementById('discountForm');
            discountTiersPreviewList = document.getElementById('discountTiersPreviewList');
            discountProductName = document.getElementById('discountProductName');
            
            // --- v10.5: Assign Decoupled Discount Calc DOM ---
            bulkProductSelect = document.getElementById('bulkProductSelect');
            bulkVariantSelect = document.getElementById('bulkVariantSelect');
            bulkQuantityInput = document.getElementById('bulkQuantityInput');
            bulkDiscountTier = document.getElementById('bulkDiscountTier');
            bulkPuhunan = document.getElementById('bulkPuhunan');
            bulkProfitPerItem = document.getElementById('bulkProfitPerItem');
            bulkTotalProfit = document.getElementById('bulkTotalProfit');
            bulkTotalPrice = document.getElementById('bulkTotalPrice');
            
            eventProductSelect = document.getElementById('eventProductSelect');
            eventVariantSelect = document.getElementById('eventVariantSelect');
            eventPromoInput = document.getElementById('eventPromoInput');
            eventPercentInput = document.getElementById('eventPercentInput');
            eventBasePrice = document.getElementById('eventBasePrice');
            eventDiscountAmount = document.getElementById('eventDiscountAmount');
            eventFinalPrice = document.getElementById('eventFinalPrice');
            eventPuhunan = document.getElementById('eventPuhunan');
            eventFinalProfit = document.getElementById('eventFinalProfit');
            
            // --- v1M: Assign Simple Calc DOM ---
            quickCalcDisplay = document.getElementById('quickCalcDisplay');
            quickCalcOperationDisplay = document.getElementById('quickCalcOperation'); // v10.9: Added
            updateQuickCalcDisplay(); // Set initial display to 0
            updateQuickCalcOperationDisplay(); // v10.9: Added
            
            // --- v11.0: Assign AI Assistant DOM ---
            aiChatHistoryContainer = document.getElementById('aiChatHistoryContainer');
            aiChatForm = document.getElementById('aiChatForm');
            aiChatInput = document.getElementById('aiChatInput');
            aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
            
            
            // --- ATTACH ALL EVENT LISTENERS ---
            confirmModalBtn.onclick = () => {
                if (modalConfirmCallback) modalConfirmCallback();
                hideConfirmModal();
            };
            
            supForm.addEventListener('submit', async (e) => {
                e.preventDefault(); if (!userId) { console.error("No user ID."); return; }
                const supData = {
                    name: document.getElementById('supName').value,
                    contact: document.getElementById('supContact').value,
                    address: document.getElementById('supAddress').value,
                    desc: document.getElementById('supDesc').value,
                };
                try {
                    console.log("Attempting to save supplier...");
                    if (editing_sup_id) {
                        console.log(`Updating supplier: ${editing_sup_id}`);
                        // v10.0 FIX: Use v8 syntax
                        const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('suppliers').doc(editing_sup_id);
                        await docRef.update(supData);
                    } else {
                        console.log("Adding new supplier...");
                        // v10.0 FIX: Use v8 syntax
                        await getSuppliersCol(userId).add(supData);
                    }
                    console.log("Supplier save success.");
                } catch (error) { console.error("Error saving supplier: ", error); }
                hideSupplierModal();
            });
            
            invForm.addEventListener('submit', async (e) => {
                e.preventDefault(); if (!userId) { console.error("No user ID."); return; }
                let newItemData = {
                    name: document.getElementById('invItemName').value,
                    desc: document.getElementById('invItemDesc').value,
                    supplierId: document.getElementById('invSupplierSelect').value,
                    mode: inv_currentMode
                };
                if (inv_currentMode === 'unit') {
                    const totalCost = parseFloat(document.getElementById('invUnitTotalCost').value);
                    const totalQty = parseFloat(document.getElementById('invUnitTotalQty').value);
                    const unitName = document.getElementById('invUnitName').value;
                    if (!totalCost || !totalQty || !unitName) { console.error("Please fill all 'Per Unit' fields."); return; }
                    newItemData.totalCost = totalCost; newItemData.totalQty = totalQty;
                    newItemData.unitName = unitName; newItemData.categories = [...inv_currentCategories];
                } else {
                    if (inv_currentOptions.length === 0) { console.error("Please add at least one size/option."); return; }
                    newItemData.options = [...inv_currentOptions];
                }
                try {
                    console.log("Attempting to save inventory item...");
                    if (editing_inv_id) {
                        console.log(`Updating inventory: ${editing_inv_id}`);
                        // v10.0 FIX: Use v8 syntax
                        const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('inventory').doc(editing_inv_id);
                        await docRef.update(newItemData);
                    } else {
                        console.log("Adding new inventory item...");
                        // v10.0 FIX: Use v8 syntax
                        await getInventoryCol(userId).add(newItemData);
                    }
                    console.log("Inventory save success.");
                } catch (error) { console.error("Error saving inventory item: ", error); }
                hideInventoryModal();
            });

            productOptionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('optionName').value;
                if (!name) { console.error("Please enter an Option Name."); return; }
                const margin = parseFloat(document.getElementById('optionMargin').value);
                const totalCost = option_currentMaterials.reduce((sum, item) => sum + item.cost, 0);
                const profit = totalCost * margin;
                const finalPrice = totalCost + profit;
                const optionData = {
                    name: name, margin: margin, items: [...option_currentMaterials],
                    totalCost: totalCost, profit: profit, finalPrice: finalPrice
                };
                if (editing_option_index !== null) calc_currentOptions[editing_option_index] = optionData;
                else calc_currentOptions.push(optionData);
                hideProductOptionModal(); renderCalcOptionsList();
            });
            
            optionMaterialSelect.addEventListener('change', () => {
                const materialId = optionMaterialSelect.value;
                optionDynamicInputs.innerHTML = '';
                if (!materialId) { optionDynamicInputs.style.display = 'none'; return; }
                const item = db_inventory.find(i => i.id === materialId);
                if (item.mode === 'unit') {
                    const unitCost = (item.totalCost && item.totalQty) ? item.totalCost / item.totalQty : 0;
                    optionDynamicInputs.innerHTML = `
                        <label class="block text-xs font-medium text-slate-500">Quantity</label>
                        <input type="number" id="optionUnitQty" placeholder="0" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 font-mono">
                        <p class="text-xs text-slate-400">Enter number of units (${item.unitName} @ ${formatMoney(unitCost)}/unit)</p>`;
                } else {
                    let optionsHtml = item.options.map(opt => `<option value="${opt.price}">${opt.name} (${formatMoney(opt.price)})</option>`).join('');
                    optionDynamicInputs.innerHTML = `
                        <label class="block text-xs font-medium text-slate-500">Select Option/Size</label>
                        <select id="optionSizeSelect" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5">${optionsHtml}</select>`;
                }
                optionDynamicInputs.style.display = 'block';
            });
            
            document.getElementById('optionMargin').addEventListener('change', updateOptionTotals);
            
            discountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!discount_currentProductId || !userId) { console.error("No product ID or User ID."); return; }
                try {
                    console.log(`Saving discounts for product: ${discount_currentProductId}`);
                    // v10.0 FIX: Use v8 syntax
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('products').doc(discount_currentProductId);
                    await docRef.update({ discounts: [...discount_currentTiers] });
                    console.log("Discounts saved.");
                } catch (error) { console.error("Error saving discounts: ", error); }
                hideDiscountModal();
            });
            
            // --- v10.5: Add Decoupled Sales Engine Listeners ---
            bulkProductSelect.addEventListener('change', handleBulkProductChange);
            bulkVariantSelect.addEventListener('change', runBulkCalculator);
            bulkQuantityInput.addEventListener('input', runBulkCalculator);
            
            eventProductSelect.addEventListener('change', handleEventProductChange);
            eventVariantSelect.addEventListener('change', runEventSaleCalculator);
            eventPercentInput.addEventListener('input', runEventSaleCalculator);
            
            // --- v11.0: Add AI Chat Listener ---
            aiChatForm.addEventListener('submit', handleAiChatSubmit);
            
            
            // --- KICK OFF THE APP ---
            initializeAuth(); // Start auth process
            showPage('sup'); // START ON SUPPLIER PAGE
            renderCalcOptionsList();
            renderCalcImagePreview();
            renderAiChat(); // Render initial AI message
            
            // Final check
            checkAppReady();
        });
        
    </script>
</body>
</html>